on:
  push:
    branches: [main, master]

name: R-CMD-check-crossplatform

jobs:
  R-CMD-check:
    runs-on: ubuntu-latest

    name: Check (${{ matrix.config.platform }})

    strategy:
      fail-fast: false
      matrix:
        config:
          -  { platform: 386 }
          -  { platform: armhf }
          -  { platform: ppc64le }
          -  { platform: s390x }
          -  { platform: riscv64 }
          -  { platform: FreeBSD }

    env:
      GITHUB_PAT: ${{ secrets.GITHUB_TOKEN }}
      R_KEEP_PKG_SOURCE: yes

    steps:
      - uses: actions/checkout@v6
        with:
          submodules: true

      - name: Setup QEMU
        if: matrix.config.platform != 'FreeBSD'
        uses: docker/setup-qemu-action@master

      - name: Check package
        if: matrix.config.platform != 'FreeBSD'
        uses: addnab/docker-run-action@v3
        with:
          image: debian:trixie-slim
          options: -v ${{ github.workspace }}:/quickjsr --platform=linux/${{ matrix.config.platform }} -e DEBIAN_FRONTEND=noninteractive -e TZ=Etc/UTC -e LANG=en_AU.UTF-8
          run: |
            apt-get update
            apt-get install --no-install-recommends -y g++ \
              r-base-core locales pandoc qpdf r-cran-tinytest r-cran-rmarkdown \
              r-cran-knitr r-cran-rcmdcheck make
            echo "en_AU.UTF-8 UTF-8" >> /etc/locale.gen
            locale-gen en_AU.UTF-8
            Rscript -e 'rcmdcheck::rcmdcheck("/quickjsr", args = c("--no-manual", "--as-cran"), check_dir = "/quickjsr/check")'

      - name: Test in FreeBSD
        if: matrix.config.platform == 'FreeBSD'
        uses: vmactions/freebsd-vm@v1
        with:
          usesh: true
          prepare: |
            pkg install -y R R-cran-tinytest R-cran-rcmdcheck R-cran-knitr R-cran-rmarkdown
          run: |
            Rscript -e 'rcmdcheck::rcmdcheck("/root/work/QuickJSR/QuickJSR", args = c("--no-manual", "--as-cran"), check_dir = "/root/work/QuickJSR/QuickJSR/check")'

      - name: Upload check results
        uses: actions/upload-artifact@v6
        with:
          name: arch-${{ matrix.config.platform }}-results
          path: check
